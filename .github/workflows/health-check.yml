name: Scheduled Health Check

on:
  schedule:
    # Runs every 1 minute
    - cron: '*/1 * * * *'
  workflow_dispatch: # Allows manual triggering for testing
  workflow_run:
    workflows: ["Deployment pipeline"]
    types:
      - completed

jobs:
  health_check:
    runs-on: ubuntu-latest
    # Only run if triggered manually, by schedule, or if the deployment workflow succeeded
    if: |
      github.event_name == 'workflow_dispatch' || 
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    steps:
      - name: Check Application Health
        uses: Jtalk/url-health-check-action@v4
        with:
          # Replace with your actual deployed application URL
          url: ${{ secrets.SERVICE_URL }}
          max-attempts: 3
          retry-delay: 5s
          follow-redirect: true
      
      - name: Health Check Failed Notification
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: 'failure'
          title: "ðŸš¨ Health Check Failed"
          description: "The application health check failed after multiple attempts. The application might be down or experiencing issues."
          color: 0xff0000
          username: Health Check Bot
      
      - name: Health Check Success
        if: success()
        run: |
          echo "âœ… Health check passed successfully"
